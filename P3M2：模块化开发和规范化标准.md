# P3M2ï¼šæ¨¡å—åŒ–å¼€å‘å’Œè§„èŒƒåŒ–æ ‡å‡†

## T1ï¼šæ¨¡å—åŒ–å¼€å‘

### æ¨¡å—åŒ–çš„æ¼”å˜ #2

#### æ—©æœŸçš„æ¨¡å—åŒ–

æ²¡æœ‰ç›¸å…³å·¥å…·å¸®åŠ©

æ–‡ä»¶åˆ’åˆ†æ–¹å¼ => å‘½åç©ºé—´æ–¹å¼ => IIFE

è§£å†³äº† æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸã€å‘½åå†²çªé—®é¢˜ã€æ— æ³•ç®¡ç†æ¨¡å—ä¾èµ–å…³ç³» è¿™ä¸‰ä¸ªé—®é¢˜ã€‚

#### æ¨¡å—åŒ–è§„èŒƒå‡ºç°

Node.js ä¸‹æœ‰ CommonJS è§„èŒƒï¼Œå³ï¼š

- ä¸€ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—
- æ¯ä¸ªæ¨¡å—éƒ½æœ‰å•ç‹¬çš„ä½œç”¨åŸŸ
- é€šè¿‡ module.exports å¯¼å‡ºæˆå‘˜
- é€šè¿‡ require å‡½æ•°è½½å…¥æ¨¡å—

ä½†æ˜¯ CommonJS æ˜¯åŒæ­¥çš„ï¼Œä¸é€‚åˆæµè§ˆå™¨ç«¯ã€‚

é€‚åº”æµè§ˆå™¨ç«¯ï¼Œå‡ºç°äº†AMD (Asynchronous Module Definition) + Require.jsï¼Œå®ƒæä¾›äº† define() æ¥å®šä¹‰æ¨¡å—ã€require() æ¥æ·»åŠ ä¾èµ–ã€‚

ä¹Ÿå‡ºç°äº† CMD (Common Module Definition) + Sea.jsï¼Œå®ƒé‡‡ç”¨äº†ä¸ CommonJS ç›¸ä¼¼çš„è§„èŒƒï¼Œä¾¿äºä¸Šæ‰‹ã€‚

#### å½“å‰çš„æ¨¡å—åŒ–è§„èŒƒ

CommonJS in Node.js

ES Module in Browsers

### ES Module çš„ä½¿ç”¨

#### ç‰¹æ€§ #5

åœ¨ HTML ä¸­ä½¿ç”¨ `<script type="module">` å¼•å…¥æ¨¡å—ï¼Œå†…å®¹ä¸­çš„ js å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚

1. ESM è‡ªåŠ¨é‡‡ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œå¿½ç•¥ `use strict`ã€‚

   ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œå…¨å±€çš„ this ä¸æŒ‡å‘å…¨å±€å¯¹è±¡ windowï¼Œè€Œæ˜¯ undefined

2. æ¯ä¸ª module éƒ½æ˜¯è¿è¡Œåœ¨å•ç‹¬çš„ç§æœ‰ä½œç”¨åŸŸä¸­

3. ESM æ˜¯é€šè¿‡ CORS å»è¯·æ±‚å¤–éƒ¨ JS æ¨¡å—çš„ã€‚

   è·¨åŸŸè¯·æ±‚å¤–éƒ¨æ¨¡å—æ—¶ï¼Œéœ€è¦æ ‡å¤´æ³¨æ˜æºåœ°å€ï¼Œä¸”æœåŠ¡ç«¯åŒæ„ã€‚

4. ESM çš„ script æ ‡ç­¾ä¼šå»¶è¿Ÿæ‰§è¡Œè„šæœ¬

   å³é»˜è®¤ differï¼Œåœ¨ç½‘é¡µæ¸²æŸ“å®Œæˆåæ‰§è¡Œè„šæœ¬

#### å¯¼å‡º export #6

æ¨¡å—å†…çš„å˜é‡ã€å‡½æ•°ã€ç±»éƒ½å¯ä»¥å¯¼å‡ºï¼Œä½¿ç”¨ export æœ‰ä¸¤ç§æ–¹å¼ï¼š

- ç›´æ¥å†™åœ¨å¯¼å‡ºå¯¹è±¡çš„å£°æ˜å‰ï¼Œå¦‚ `export var name = 'Tom'`
- ã€å¸¸ç”¨ã€‘ï¼ˆåœ¨æ¨¡å—å°¾ï¼‰å°†å„é¡¹ä»¥ `{}` åŒ…è£¹å¯¼å‡ºï¼Œå¦‚ `export { name, foo }`

å¯¼å‡ºæ—¶å¯ä»¥è®¾ç½®é»˜è®¤é¡¹å’Œé‡å‘½åï¼Œå¦‚ `export { name as newName, foo as default }`

é‡å‘½åçš„é¡¹åœ¨è¢«å¯¼å…¥æ—¶ï¼Œéœ€è¦ä»¥æ–°åå­—å¯¼å…¥ï¼Œå³ `import newName`;

é»˜è®¤é¡¹éœ€åœ¨è¢«å¯¼å…¥æ—¶é‡å‘½åï¼Œå¦‚ `import default as newFoo`ï¼Œæˆ–ç®€å†™ä¸º `import newFoo`

ã€æ³¨æ„ã€‘

- å¤šé¡¹å¯¼å‡ºæ—¶ï¼Œå¹¶éå¯¼å‡ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯å¯¼å‡ºçš„å›ºå®šè¯­æ³•ã€‚åŒæ ·çš„ï¼Œå¯¼å…¥æ—¶ï¼Œä¹Ÿéè§£æ„å¯¹è±¡ã€‚
- å¯¼å…¥çš„é¡¹è·å–åˆ°çš„æ˜¯å¼•ç”¨åœ°å€ï¼Œè€Œéè¯¥é¡¹çš„ä¸€ä»½æ–°æ‹·è´ã€‚ä¹Ÿå³ï¼Œå¯¼å‡ºé¡¹çš„å˜åŒ–ï¼Œå¯¼å…¥ç«¯å¯ä»¥å®æ—¶è·å–åˆ°ï¼Œä½†å®ƒæ˜¯åªè¯»çš„ï¼Œä¸èƒ½åœ¨å¯¼å…¥ç«¯ä¿®æ”¹ã€‚

#### å¯¼å…¥ import #8

- å¯¼å…¥æ—¶ï¼Œfrom åè·Ÿå…·ä½“çš„æ¨¡å—æ–‡ä»¶URL
  - æ¨¡å—æ–‡ä»¶çš„æ‰©å±•åä¸èƒ½çœç•¥
  - URL å¯ä»¥æ˜¯ç›¸å¯¹ URLï¼Œä»¥ `./` å¼€å¤´ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹ URLï¼Œä»¥ `/` å¼€å¤´ï¼Œè¿˜å¯ä»¥æ˜¯å®Œæ•´çš„ URL åœ°å€ï¼Œä¾‹å¦‚  CDN ä¸Šçš„æ¨¡å—æ–‡ä»¶ã€‚

- å¯¼å…¥çš„å¦ä¸€ç§ç”¨æ³•ï¼š`import {} form './module.js'` æˆ–ç®€å†™ä¸º `import './module.js'`ï¼Œæ‰§è¡Œè¯¥æ¨¡å—ï¼Œè€Œä¸æå–å…¶ä¸­å¯¼å‡ºã€‚
- å…¨éƒ¨å¯¼å…¥æŸä¸€æ¨¡å—çš„å¯¼å‡ºï¼š`import * as mod`ã€‚mod åˆ™æ˜¯åŒ…å«æ‰€æœ‰å¯¼å‡ºé¡¹çš„å¯¹è±¡
- åŠ¨æ€å¯¼å…¥æ¨¡å—ä½¿ç”¨å‡½æ•° `import()`ï¼Œå¦‚ `import('./module.js').then(function (mod) {console.log(mod)})` ã€‚æ¨¡å—å†…çš„å¯¼å‡ºé€šè¿‡ then å¾—åˆ°ã€‚
- åŒæ—¶å¯¼å…¥é»˜è®¤å’Œå‘½åæˆå‘˜ï¼š`import {name, age, default as newFoo} form './module.js'` æˆ– `import newFoo, {name, age} from './module.js'`

#### åŒæ—¶å¯¼å…¥å’Œå¯¼å‡º #9

`export {name, age} from './module.js'`

è¿™ä¸€å†™æ³•é€šå¸¸ç”¨åœ¨ä½¿ç”¨ä¸€ä¸ªæ¨¡å—ç®¡ç†å¤šä¸ªæ¨¡å—å¯¼å…¥å¯¼å‡ºçš„æƒ…å†µã€‚å°†å¤šä¸ªæ¨¡å—çš„å¯¼å‡ºå¯¼å…¥åˆ° index.jsï¼Œå¹¶åŒæ—¶å¯¼å‡ºï¼Œè¿™æ ·åœ¨ä¸»é¡µåªéœ€å¯¼å…¥ index.js æ¨¡å—å³å¯ã€‚

#### ES Module çš„å…¼å®¹æ€§å¤„ç† #10

å¯¹äºä¸æ”¯æŒ ES Module çš„æµè§ˆå™¨å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

1. å¼•å…¥ `babel-browser-build` å’Œ `browser-es-module-loader`ï¼Œè½¬åŒ–ä¸ºé€šç”¨è¯­æ³•ã€‚

   å¯ä»¥ä½¿ç”¨ script æ ‡ç­¾ä» unpkg.com å¼•å…¥ã€‚

2. ä¹Ÿä¸æ”¯æŒ Promise çš„æµè§ˆå™¨è¿˜éœ€å¼•å…¥ `promise-polyfill` ã€‚

3. ä¸ºä»¥ä¸Šå¼•å…¥æ·»åŠ  `nomodule` å±æ€§ï¼Œé¿å…æ­£å¸¸æµè§ˆå™¨æ‰§è¡Œä¸¤æ¬¡ä»£ç ã€‚

ä¸Šè¿°çš„å¼•å…¥æ–¹æ³•è¯·æ±‚è¿‡å¤šï¼Œä¸é€‚ç”¨äºä¸Šçº¿è¿è¡Œã€‚

### ES Module in Node.js

Node.js ä¹Ÿé€æ­¥åŠ å…¥äº†å¯¹ ES Module çš„æ”¯æŒ

ä¸æµè§ˆå™¨ä¸‹çš„ä¸»è¦åŒºåˆ«ï¼šæ¨¡å—æ‰©å±•åä¸º `.mjs`ï¼ˆåŒæ—¶æ³¨æ„ä¿®æ”¹å¯¼å…¥æ–‡ä»¶çš„ URLï¼‰

#### ES æ¨¡å—ä¸ CJS æ¨¡å—çš„äº¤äº’ #11~12

ESM å¯¼å…¥ CJS æ¨¡å—çš„æ–¹æ³•ï¼š

CJS ä¸‹ï¼Œæ¨¡å—çš„å¯¼å‡ºæ˜¯ä»¥å¯¹è±¡å½¢å¼ï¼ŒåŒ…å«äº†å„ç§å±æ€§ã€æ–¹æ³•ã€‚å› æ­¤åœ¨ ES æ¨¡å—ä¸‹åªèƒ½é»˜è®¤å¼•å…¥ï¼Œå¼•å…¥çš„æ˜¯ `module.exports` å¯¹è±¡ï¼Œä½¿ç”¨åº“æ—¶éœ€è¦è°ƒç”¨å¯¹è±¡å†è°ƒç”¨å±æ€§æ–¹æ³•ã€‚

e.g. `import _ from 'lodash'; console.log(_.camelCase(Import From CJS Module))`

æ²¡æœ‰å¯¹ ESM åšå…¼å®¹çš„ç¬¬ä¸‰æ–¹åŒ…ä¾¿å¿…é¡»ä»¥æ­¤å½¢å¼å¼•äººã€‚ä¹Ÿæœ‰ç¬¬ä¸‰æ–¹åŒ…æ˜¯åˆ†ç¦»å‡ºæ¥ä¸€ä¸ªä¸“ç”¨çš„ ES åŒ…ï¼Œä¾‹å¦‚ `lodash-es`

e.g. `import camelCase from 'lodash-es'; console.log(camelCase(Import From ES Module))`

Node.js çš„å†…ç½®æ¨¡å—åšäº†å…¼å®¹ï¼Œåœ¨æ¨¡å—å†…åšäº†ä¸¤ç§å¯¼å‡ºï¼Œå› æ­¤ä¸Šè¿°ä¸¤ç§å¯¼å…¥æ–¹å¼å‡å¯ã€‚

Node.js ä¸‹ï¼ŒCJS æ¨¡å—ä¸èƒ½å¯¼å…¥ ES æ¨¡å—ã€‚

#### ES æ¨¡å—ä¸ CJS æ¨¡å—çš„å·®å¼‚ #13

ESM ä¸­æ— æ³•è·å–åˆ° CommonJS ä¸­çš„å…¨å±€æˆå‘˜äº†ï¼ŒåŒ…æ‹¬ `module`ã€`require()`ã€`exports`ã€`__filename`ã€`__dirname`

require å’Œ exports å®ç°å¼•å…¥å’Œå¯¼å‡ºï¼Œåœ¨ ESM ä¸­æœ‰ import å’Œ export å¯¹åº”è´Ÿè´£ã€‚

`__filename` å’Œ `__dirname` ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ›¿ä»£ï¼š

```js
import { fileURLToPath } from 'url'
import { dirname } from 'path'
const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
```

#### Node.js å¯¹ ESM çš„æ–°æ”¯æŒ #14

å¯åœ¨ package.json ä¸­åŠ å…¥ `'type': 'module'` å­—æ®µï¼Œé‚£ä¹ˆ js æ–‡ä»¶å³ä»¥ ESM è¿è¡Œäº†ï¼Œè€Œ CJS æ¨¡å—åˆ™éœ€è¦ä¿®æ”¹æ‰©å±•åä¸º `.cjs` æ‰å¯æ­£å¸¸è¿è¡Œã€‚

#### æ—§ç‰ˆ Node ä¸­ä½¿ç”¨ ESMï¼ˆå€ŸåŠ© babelï¼‰#15

å®‰è£… `@babel/node` ï¼Œé…ç½®è½¬ç è§„åˆ™ä¸º @babel/plugin-transform-modules-commonjs æˆ–åŒ…å«å®ƒçš„ @babel/preset-env

å³å¯åœ¨å‘½ä»¤è¡Œä¸­ `babel-node esModule.js` ç›´æ¥è°ƒç”¨ ES æ¨¡å—ã€‚

## T2ï¼šWebpack æ‰“åŒ…å·¥å…·

### åŸºæœ¬ä½¿ç”¨æ–¹æ³•

å°†å¤šä¸ª js æ¨¡å—æ‰“åŒ…ä¸ºä¸€ä¸ª js æ–‡ä»¶ï¼Œæ­¤æ—¶åœ¨ HTML çš„å¼•å…¥æ— éœ€ `type="module"` å±æ€§

#### é…ç½®æ–‡ä»¶ #4

åœ¨æ ¹ç›®å½•åˆ›å»º webpack.config.js æ–‡ä»¶

- å…¥å£
- è¾“å‡º

```js
const path = require('path')
module.exports = {
	entry: './src/app.js',					//å…¥å£ï¼Œé»˜è®¤æ˜¯'./src/main.js'
	output: {
		filename: 'bundle.js',				//æ–‡ä»¶åï¼Œé»˜è®¤æ˜¯'main.js'
		path: path.join(__dirname, 'output')//è¾“å‡ºç»å¯¹è·¯å¾„
	}
}
```

- å·¥ä½œæ¨¡å¼ #5

  e.g. `mode: 'none'`

  ä¸åŒçš„å·¥ä½œæ¨¡å¼ç›¸å½“äºä¸åŒçš„é…ç½®ç»„ï¼Œä¹Ÿå¯æ·»åŠ å‘½ä»¤è¡Œå‚æ•° `--mode XXX` ä½¿ç”¨ã€‚é»˜è®¤ production æ¨¡å¼ã€‚

  - production ä¸Šçº¿ç”¨
  - development ä¼˜åŒ–æ‰“åŒ…é€Ÿåº¦ï¼Œæ·»åŠ å¼€å‘ç”¨è¯´æ˜
  - none æ— é™„åŠ 

### Webpack çš„åŠ è½½å™¨ loader

Webpack é»˜è®¤ loader å¯ä»¥æ‰“åŒ… js æ¨¡å—ï¼Œå…¶ä»–èµ„æºæ¨¡å—éœ€è¦æ–°å¢ loader æ¥å¤„ç†ã€‚

loader æ˜¯ Webpack çš„æ ¸å¿ƒ #14ã€‚

#### å¸¸ç”¨ loader åˆ†ç±» #11

- ç¼–è¯‘è½¬æ¢ç±»ï¼šè½¬ä¸ºä»¥ js å½¢å¼å·¥ä½œçš„æ¨¡å—

- æ–‡ä»¶æ“ä½œç±»ï¼šæ–‡ä»¶æ‹·è´è‡³ç›®å½•ï¼Œå¹¶å¯¼å‡ºè®¿é—®è·¯å¾„

- ä»£ç æ£€æŸ¥ç±»ï¼šæ£€æŸ¥ã€ç»Ÿä¸€ä»£ç é£æ ¼

#### åŠ è½½ CSS èµ„æº #7

css-loaderï¼šå°† CSS æ–‡ä»¶è½¬æ¢ä¸º js æ¨¡å—å¹¶æ‰“åŒ…

style-loaderï¼šå°† CSS æ¨¡å—è¿½åŠ è¿› HTML æ¸²æŸ“

éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ–°å¢ module å­—æ®µï¼š

```json
module: {
    rules: [
        {
            test: /.css$/,		//åŒ¹é…æ–‡ä»¶è·¯å¾„ï¼Œæ­£åˆ™è¡¨è¾¾å¼
            use: 'css'			//ä½¿ç”¨çš„ loaderï¼Œä»ä¸‹å¾€ä¸Šæ‰§è¡Œ
        }
    ]
}
```

ä¸”å°† CSS æ–‡ä»¶å¼•å…¥å…¥å£ js æ–‡ä»¶

#### åŠ è½½æ–‡ä»¶èµ„æº #9

å›¾ç‰‡ã€å­—ä½“ç­‰æ–‡ä»¶ä¸èƒ½åƒ CSS è½¬ä¸º JavaScript ä»£ç ï¼Œå®ƒä»¬éœ€è¦ä½¿ç”¨æ–‡ä»¶åŠ è½½å™¨ file-loaderã€‚ä¸è¿‡å®ƒä»¬ä¹Ÿéœ€è¦ import åˆ°å…¥å£æ–‡ä»¶ä¸­ã€‚

ã€æ³¨æ„ã€‘Webpack é»˜è®¤ HTML æ–‡ä»¶åœ¨ output.path çš„ä½ç½®ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™éœ€è¦é…ç½® output.publicPath å€¼ä¸ºè¾“å‡ºç›®å½•ç›¸å¯¹ HTML æ–‡ä»¶çš„è·¯å¾„ï¼Œç»“å°¾ä¿ç•™ `/` ã€‚è¿™æ ·ï¼Œåœ¨ HTML è®¿é—®é™æ€èµ„æºæ—¶ï¼ŒpublicPath æ‹¼æ¥ loader é…ç½®çš„è·¯å¾„æ–¹ä¸ºæ­£ç¡®è·¯å¾„ã€‚

#### åŠ è½½ DataURL èµ„æº #10

url-loader

é€‚ç”¨äºå°æ–‡ä»¶ï¼Œä½¿ç”¨ DataURL ä»¥å‡å°‘ HTTP è¯·æ±‚ã€‚

åœ¨é…ç½®æ–‡ä»¶ module.rules ä¸‹çš„ use.option æ·»åŠ å±æ€§ limitï¼Œé™åˆ¶ä½¿ç”¨ url-loader å¤„ç†çš„æ–‡ä»¶å¤§å°ã€‚è¶…è¿‡è¯¥é™åˆ¶å¤§å°çš„æ–‡ä»¶ä»ä½¿ç”¨ file-loader åŠ è½½ï¼Œä¹Ÿå°±æ˜¯è¯´ä¾èµ– file-loader

e.g.

```js
module: {
    rules: [
        {
            test: /.png$/,
            use: {
                loader: 'url-loader',
                option: {
                    limit: 10 * 1024	//æ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10 kB
                }
            }
        }
    ]
}
```

#### æ·»åŠ å¯¹ ES6 çš„æ”¯æŒ #12

Webpack ä»…æ˜¯ä¸€ä¸ªæ‰“åŒ…å·¥å…·ï¼Œæœ¬èº«ä¸æ”¯æŒ ES6+ã€‚å¯ä»¥ä½¿ç”¨ babel-loader ä»£æ›¿é»˜è®¤ loader æ¥åŠ è½½ js æ–‡ä»¶ï¼Œä»¥å®ç°å¯¹ ES6 çš„æ”¯æŒã€‚

```json
module: {
    rules: [
        {
        test: /.js$/,
        use: {
            loader: 'babel-loader',
            options: {
                presets: ['@babel/preset-env']
            }
        }
    ]
}
```

#### å…¶ä»–èµ„æºå’Œæ–‡ä»¶çš„åŠ è½½ #13

##### ä¸åŒæ ‡å‡†æ¨¡å—çš„å¯¼å…¥

- éµå¾ª ES Module æ ‡å‡†çš„ import å£°æ˜
- éµå¾ª CommonJS æ ‡å‡†çš„ require å£°æ˜
- éµå¾ª AMD æ ‡å‡†çš„ define å‡½æ•°å’Œ require å‡½æ•°

è™½ç„¶ Webpack æ”¯æŒå¤šç§æ ‡å‡†ï¼Œä½†æ˜¯åœ¨åŒä¸€é¡¹ç›®ä¸­æœ€å¥½è¿˜æ˜¯ä½¿ç”¨ç»Ÿä¸€æ ‡å‡†çš„æ¨¡å—ã€‚

##### CSS ä¸­çš„ @import å’Œ url()

CSS å†…å¼•å…¥çš„å…¶ä»– CSS æ–‡ä»¶å’Œé€šè¿‡ url() è·å–çš„æ–‡ä»¶å‡å¯æ­£ç¡®åŠ è½½

##### HTML ä¸­çš„ &lt;img> çš„src å’Œ &lt;a> çš„ href

å®‰è£… html-loader å¹¶æ·»åŠ ä¸€ç»„è§„åˆ™ï¼š

```json
{
    test: '/.html$/',
    use: {
        loader: 'html-loader',
        options: {
            attrs: ['img:src', 'a:href']
        }
    }
}
```

é»˜è®¤å¯ä»¥å¤„ç† img å…ƒç´ çš„ src å±æ€§ï¼Œå³ options.attrs çš„é»˜è®¤å€¼æ˜¯ `'img:src'`

#### loader çš„å·¥ä½œåŸç† #15

loader å®Œæˆçš„å³æ˜¯èµ„æºæ–‡ä»¶ä»è¾“å…¥åˆ°è¾“å‡ºçš„è½¬æ¢

loader æ˜¯ä¸€ä¸ªç®¡é“çš„æ¦‚å¿µï¼Œå¯¹åŒä¸€èµ„æºå¯ä»¥ä½¿ç”¨å¤šä¸ª loader æ¥ç»­ï¼Œæœ€ç»ˆçš„è¾“å‡ºåº”æ˜¯ js ä»£ç ã€‚

### Webpack çš„æ’ä»¶ plugin

æ’ä»¶å¯ä»¥å®Œæˆæ‰“åŒ…ä»¥å¤–çš„å…¶ä»–ä¸€äº›è‡ªåŠ¨åŒ–å·¥ä½œ

#### æ¸…ç†ç›®å½•ç”¨æ’ä»¶ #17

å®‰è£…æ’ä»¶åï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¼•å…¥ï¼ˆrequireï¼‰æ’ä»¶ï¼Œå¹¶åœ¨å¯¼å‡ºé¡¹çš„ plugins æ•°ç»„å†…ï¼Œå†™å…¥æ’ä»¶çš„æ–°å»ºå®ä¾‹ï¼Œå¦‚ `new CleanWebpackPlugin()`

clean-webpack-pluginï¼šæ‰“åŒ…å‰æ¸…ç©ºè¾“å‡ºç›®å½•

#### è‡ªåŠ¨ç”Ÿæˆ HTML ç”¨æ’ä»¶ #18~20

html-webpack-pluginï¼šè‡ªåŠ¨åœ¨è¾“å‡ºç›®å½•ç”Ÿæˆå¼•ç”¨äº† Webpack å·²æ†ç»‘åŒ…çš„ HTML æ–‡ä»¶

html-webpack-plugin å¯ä»¥æ›´è¯¦ç»†çš„é…ç½®

##### é¢„è®¾ç”Ÿæˆçš„ HTML

åœ¨æ–°å»º html-webpack-plugin å®ä¾‹æ—¶ï¼Œä¼ å…¥ä¸€ä¸ªå¯¹è±¡å®å‚ï¼Œå†…ç½®ä¸€äº›å±æ€§å¯ä»¥è‡ªå®šä¹‰ä¿®æ”¹ç”Ÿæˆçš„ HTML æ–‡ä»¶ã€‚e.g. 

```js
{
    title: 'Custom Title',
    meta: {
        viewport: 'width=device-width'
    }
}
```

æ›´å¤§çš„è‡ªå®šä¹‰å¯ä»¥ä½¿ç”¨æ¨¡æ¿æ¥å®ç°ï¼Œæ¨¡æ¿å†…éœ€è¦åŠ¨æ€æ³¨å…¥çš„éƒ¨åˆ†ä½¿ç”¨ lodash æ¨¡æ¿è¯­æ³•ã€‚e.g.

```js
{
    template: './src/template.html'
}
```

```html
<body>
    <h1><%= htmlWepackPlugin.options.title %></h1>
</body>
```

##### åˆ›å»ºå¤šä¸ª HTML æ–‡ä»¶

æ–°å»ºå¤šä¸ªå®ä¾‹ï¼Œå¹¶ä¼ å…¥å‚æ•°å¯¹è±¡ `{ filename: 'about.html' }` ä¿®æ”¹æ–‡ä»¶åã€‚

#### ç§»åŠ¨æ–‡ä»¶ç”¨æ’ä»¶

copy-webpack-pluginï¼šå°†æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ°è¾“å‡ºç›®å½•ï¼Œæ¯”å¦‚å›¾æ ‡ç±»å›¾ç‰‡ã€‚

åœ¨ plugins ä¸‹æ–°å»ºå®ä¾‹æ—¶ï¼Œä¼ å…¥å®å‚ä¸ºè¦å¤åˆ¶çš„ç›®å½•

ã€å·¥ä½œã€‘é€šå¸¸åœ¨ä¸Šçº¿å‰åšä¸€æ¬¡é™æ€æ–‡ä»¶å¹¶å…¥ï¼Œå¼€å‘è¿‡ç¨‹ä¸­èƒ½è®¿é—®å³å¯ã€‚

#### plugin çš„å·¥ä½œåŸç† #22

é€šè¿‡åœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­çš„é’©å­ä¸ŠæŒ‚è½½å‡½æ•°å®ç°æ‰©å±•

### Webpack Dev Server

éšœç¢1ï¼šæºä»£ç ä¿®æ”¹åï¼Œæƒ³è¦åœ¨æµè§ˆå™¨ç«¯çœ‹åˆ°æ•ˆæœï¼Œéœ€è¦æœ‰é‡æ–°ç¼–è¯‘æ‰“åŒ…å’Œåˆ·æ–°é¡µé¢çš„æ“ä½œã€‚

- è‡ªåŠ¨ç¼–è¯‘ï¼šWebpack `--watch` å·¥ä½œæ¨¡å¼ï¼Œç›‘å¬æ–‡ä»¶ä¿®æ”¹ï¼Œè‡ªåŠ¨æ‰“åŒ…

- è‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨ï¼šåˆ©ç”¨ browser-sync ä¸Šçº¿å¹¶ç›‘å¬æ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ·æ–°

ä½†è¿™æ ·çš„â€œä¸¤æ­¥è‡ªåŠ¨åŒ–â€ä¸­é—´äº§ç”Ÿäº†åå¤çš„ç£ç›˜è¯»å†™ï¼Œæ‹–ç´¯æ•ˆç‡ã€‚

webpack-dev-server æ˜¯ Webpack æ¨å‡ºçš„å¼€å‘å·¥å…·ï¼Œå¯ä»¥å®ç°è‡ªåŠ¨ç¼–è¯‘å’Œè‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨

#### æ·»åŠ å¯¹é™æ€èµ„æºçš„è®¿é—® #27

config.js é…ç½®æ–‡ä»¶ => devServer å¯¹è±¡ => contentBase æ•°ç»„å±æ€§

e.g. `devServer: { contentBase: [ './public', './base'] }`

#### ä»£ç† API #28

å¼€å‘è¿‡ç¨‹é¡µé¢åœ¨æœ¬åœ°å¯¹æœåŠ¡å™¨è¯·æ±‚å±äºè·¨åŸŸè¯·æ±‚ï¼Œä¸Šçº¿åæ˜¯åŒæºã€‚

å¦‚æœæœåŠ¡å™¨ä¸æ”¯æŒ CORS è·¨åŸŸï¼Œé‚£ä¹ˆä¾¿éœ€è¦å°†æœ¬åœ°ä»£ç†åˆ°åŒæºçš„å¼€å‘ç”¨æœåŠ¡å™¨ä¸Šè¿›è¡Œå¼€å‘ã€‚

config.js é…ç½®æ–‡ä»¶ => devServer å¯¹è±¡ => proxy å¯¹è±¡å±æ€§

```js
devServer: {
    proxy: {
        '/api': {			// ä»¥ '/api' å¼€å¤´çš„åœ°å€
            target: 'https://api.github.com',
            // ğŸ‘† https://localhost:8080 æ›¿æ¢ä¸º https://api.github.com
            pathRewrite: {	// é‡å†™
                '^/api': ''
                // ğŸ‘† https://localhost:8080/api/users ä¿®æ­£ä¸º https://api.github.com/users
            },
            changeOrigin: true
        }
    }
}
```

#### æ¨¡å—çƒ­æ›´æ–° MHR

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¿ç•™é¡µé¢çŠ¶æ€ä¸‹è°ƒè¯•ä»£ç ï¼Œè€Œé¡µé¢è‡ªåŠ¨åˆ·æ–°ä¼šå¯¼è‡´æ•ˆç‡é™ä½ã€‚

æ¨¡å—çƒ­æ›´æ–° (Hot Module Replacement) èƒ½å¤Ÿå®ç° CSSã€JSã€å›¾ç‰‡ç­‰èµ„æºæ–‡ä»¶éšæ”¹éšä¸Šï¼Œè€Œæ— éœ€åˆ·æ–°ã€‚

##### å¼€å¯ MHR #37

MHR æ˜¯ Webpack Dev Server çš„å†…ç½®æ’ä»¶ã€‚

åœ¨å‘½ä»¤ webpack-dev-server ååŠ  `--hot` å‘½ä»¤è¡Œå‚æ•°å³å¯ã€‚

æˆ–é…ç½® `devServer: { hot: true }`ï¼Œä¸”éœ€å¼•å…¥ webpack å’Œæ–°å»ºæ’ä»¶å®ä¾‹ã€‚

è¿™æ—¶ï¼ŒCSS å·²ç»å¯ä»¥çƒ­æ›¿æ¢äº†ã€‚

##### è¿›ä¸€æ­¥é…ç½®çƒ­æ›¿æ¢é€»è¾‘ #38

ã€æ³¨æ„ã€‘é€šè¿‡æ¡†æ¶ç”Ÿæˆçš„é¡¹ç›®å¯èƒ½ä¸éœ€è¦å†é…ç½®ï¼Œå› ä¸ºæ¡†æ¶å·²åšå¥½äº† MHR å®Œæ•´é…ç½®ã€‚

åœ¨å¼•å…¥æ¨¡å—çš„æ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯å…¥å£æ–‡ä»¶ï¼‰å¤„ç†çƒ­æ›¿æ¢ã€‚

```js
module.hot.accept('./editor', ()=>{})
```

module.hot æ˜¯ MHR APIs çš„æ ¸å¿ƒå¯¹è±¡ï¼Œå®ƒæä¾› accept()ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¨¡å— URLï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¯¥æ¨¡å—æ›´æ–°åçš„å¤„ç†å‡½æ•°ã€‚

ä¸åŒçš„æ¨¡å—éœ€è¦ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œæ ¹æ®æ¨¡å—é€»è¾‘è‡ªè¡Œä¹¦å†™ã€‚

###### js æ¨¡å— #40

e.g. ç¼–è¾‘å™¨æ¨¡å—

```js
let lastEditor = editor					// ä¿ç•™åŸæ¨¡å—ç»“æœ
module.hot.accept('./editor', ()=>{
    const value = lastEditor.innerHTML	// ä¿ç•™åŸçŠ¶æ€
    document.body.removeChild(lastEditor)// ç§»é™¤åŸæ¨¡å—ç»“æœ
    const newEditor = createEditor()	// ç”Ÿæˆæ–°æ¨¡å—ç»“æœ
    newEditor.innerHTML = value			// æ–°æ¨¡å—ç»“æœå¾—åˆ°åŸçŠ¶æ€
    document.body.appendChild(newEditor)
    lasteditor = newEditor
})
```

###### å›¾ç‰‡æ¨¡å— #41

```js
module.hot.accept('./pic.png', ()=>{
    img.src = background		// é‡èµ‹ä¸€æ¬¡å›¾ç‰‡åœ°å€ï¼Œå³å®ç°å›¾ç‰‡åˆ·æ–°
})
```

##### MHR çš„æ³¨æ„äº‹é¡¹ #42

1. `hot: true` ä¸‹ï¼Œå¦‚æœä¿®æ”¹æ¨¡å—å‡ºç°é”™è¯¯ï¼Œé¡µé¢è‡ªåŠ¨é‡è½½ä¿®æ”¹å‰çš„æ¨¡å—ã€‚

   å¯ä½¿ç”¨ `hotOnly: true`ï¼Œå‡ºé”™æƒ…å†µä¸‹é¡µé¢ä¹Ÿä¸é‡è½½ï¼Œä¾¿äºè§‚å¯Ÿ bug

2. ä¸º MHR åŠ å‰ç½®åˆ¤æ–­æ¡ä»¶ `if(module.hot)`ï¼Œé¿å…æŠ¥é”™ï¼Œä¸”ä¸Šçº¿ç”Ÿäº§ç¯å¢ƒæ—¶ç›¸å…³ä»£ç ä¹Ÿä¸ä¼šè¿›å…¥æ‰“åŒ…ã€‚

#### Source Map

éšœç¢2ï¼šé¡¹ç›®ç»è¿‡æ‰“åŒ…ç¼–è¯‘åï¼Œå˜é‡åå’Œæ–‡ä»¶ç»“æ„ç­‰éƒ½è¢«ä¿®æ”¹ï¼Œåœ¨æµè§ˆå™¨ç«¯è°ƒè¯•æ— æ³•ä¸æºç å¯¹åº”ã€‚

æºç åœ°å›¾å»ºç«‹æ‰“åŒ…åä»£ç ä¸æºä»£ç é—´çš„æ˜ å°„ï¼Œä¾¿äºç›´è§‚è°ƒè¯•ã€‚

##### é…ç½® Webpack çš„ Source Map #30

æ·»åŠ å­—æ®µï¼š`devtool: 'source-map'`

##### Source Map çš„æ¨¡å¼ #32~33

evalï¼ˆç±» Source Mapï¼‰

`devtool: 'eval'`

èƒ½å®šä½åˆ°æºæ–‡ä»¶ï¼Œæ²¡æœ‰ Source Mapï¼Œä¹Ÿå°±æ²¡æœ‰å…·ä½“è¡Œã€åˆ—ä¿¡æ¯ã€‚é€Ÿåº¦æœ€å¿«ï¼Œæ•ˆæœç®€é™‹ã€‚

- å¸¦æœ‰ eval è¡¨ç¤ºä½¿ç”¨äº† eval çš„æ‰§è¡Œæ¨¡å—ä»£ç 

- å¸¦æœ‰ cheap è¡¨æ˜ç®€æ˜“ï¼Œé€Ÿåº¦æ›´é«˜

- å¸¦æœ‰ module è¡¨æ˜èƒ½å¾—åˆ° loader å¤„ç†å‰çš„æºä»£ç 

###### æ¨¡å¼é€‰æ‹©ï¼š

å¼€å‘ï¼šcheap-module-eval-source-map

ç”Ÿäº§ï¼šnone / nosources-source-map

### Webpack çš„ä¸åŒæ¨¡å¼é…ç½®

åœ¨é»˜è®¤é…ç½®çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ åˆ¤æ–­ä¿®æ”¹é…ç½®ã€‚æ­¤æ–¹æ³•é€‚ç”¨äºå°å‹é¡¹ç›®ã€‚

```js
module.exports = (env, argv) => {
    const config = {Â·Â·Â·}
    
    if (env === 'production') {
        config.mode = 'production'
        config.devtool = false
        config.plugins = [
            ...config.plugins,
            new CleanWebpackPlugin(),
            new CopyWebpackPlugin(['public'])
        ]
    }
    return config
}
```

è¿™æ ·åœ¨æ‰“åŒ…æ—¶åŠ å‘½ä»¤è¡Œå‚æ•° `--env production` å³å¯ä½¿ç”¨ç”Ÿäº§æ¨¡å¼é…ç½®ã€‚

å¤§å‹é¡¹ç›®ä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶æ›´ä¸ºå¯é ï¼Œé€šå¸¸æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼š`webpack.common.js`ã€`webpack.dev.js`ã€`webpack.prod.js`

common ä½œä¸ºåŸºç¡€é…ç½®æ–‡ä»¶ï¼Œè¢« dev å’Œ prod å¼•å…¥ä½œä¸ºä¸€ä¸ªå¯¹è±¡å¸¸é‡ã€‚`const common = require('./webpack.common')`

å†å°†ä¿®æ”¹å€¼å†™å…¥ã€‚è¿™é‡Œä½¿ç”¨ webpack-merge åŒ…çš„ merge() å¤„ç†é…ç½®å¯¹è±¡èåˆã€‚`module.exports = common, {Â·Â·Â·}` ã€‚merge å‡½æ•°èƒ½è‡ªåŠ¨å¤„ç†æ•°ç»„ç±»å‹å€¼çš„è¿½åŠ ï¼Œè€Œä¸æ˜¯è¦†ç›–ã€‚

æ‰“åŒ…æ—¶éœ€è¦ `webpack --config webpack.prod.js`ï¼Œå¯ä»¥å†™è¿› npm scripts ä½¿ç”¨ã€‚

